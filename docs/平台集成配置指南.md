# GEO工具 - 飞书/Notion双平台集成配置指南

## 🎯 快速开始（5分钟上手）

### 第一步：安装依赖

```bash
cd /Users/xuan/Documents/write\ agent/geo_business_tool
pip install -r requirements_platform.txt
```

### 第二步：选择你的平台

你可以选择：
1. **飞书（推荐国内客户）** - 速度快、通知及时、移动端体验好
2. **Notion（推荐国际客户）** - 界面美观、知识管理强大
3. **双平台（最佳方案）** - 国内客户用飞书，国际客户用Notion

---

## 🚀 方案A：使用飞书（5分钟配置）

### 1. 创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/app)
2. 点击"创建自建应用"
3. 填写应用名称："GEO工具"
4. 获取 **App ID** 和 **App Secret**（保存好！）

### 2. 创建多维表格

1. 在飞书中创建一个多维表格应用
2. 创建4张表（按照下面的字段设计）：

#### 表1：客户信息表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 客户名称 | 单行文本 | 必填 |
| 行业类型 | 单选 | 医美/护肤/器械/其他 |
| 联系人 | 单行文本 | - |
| 项目状态 | 单选 | 待启动/进行中/已完成/暂停 |
| 开始日期 | 日期 | - |
| 备注 | 多行文本 | - |

#### 表2：项目执行表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 项目ID | 单行文本 | 关联项目 |
| 执行阶段 | 单选 | D/B/C/A |
| 执行状态 | 单选 | 待执行/执行中/已完成/失败 |
| 开始时间 | 日期时间 | - |
| 完成时间 | 日期时间 | - |
| 耗时(分钟) | 数字 | - |
| 质量评分 | 数字 | 1-5 |
| 备注 | 多行文本 | - |

#### 表3：压力测试记录表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 项目ID | 单行文本 | 关联项目 |
| 测试时间 | 日期时间 | - |
| 测试引擎 | 多选 | DeepSeek/ChatGPT/Kimi |
| 关键词数量 | 数字 | - |
| 平均得分 | 数字 | - |
| 提及率 | 数字 | 百分比 |
| 趋势 | 单选 | ↑/→/↓ |

#### 表4：客户反馈表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| 反馈时间 | 日期时间 | - |
| 客户名称 | 单行文本 | - |
| 反馈类型 | 单选 | 满意/建议/投诉 |
| 反馈内容 | 多行文本 | - |
| 处理状态 | 单选 | 待处理/处理中/已解决 |

### 3. 获取表格Token

1. 打开你创建的多维表格
2. 从URL中提取信息：
   - URL格式：`https://xxx.feishu.cn/base/YOUR_APP_TOKEN?table=YOUR_TABLE_ID`
   - `YOUR_APP_TOKEN` → 填入配置的 `app_token`
   - 每张表的 `YOUR_TABLE_ID` → 分别填入对应表的配置

### 4. 创建机器人（可选，用于通知）

1. 在飞书群聊中，点击"设置" → "群机器人" → "添加机器人"
2. 选择"自定义机器人"
3. 复制 **Webhook URL**

### 5. 填写配置文件

编辑 `config/platform_config.yaml`：

```yaml
default_platform: feishu

feishu:
  app_id: "YOUR_APP_ID"              # 步骤1获取
  app_secret: "YOUR_APP_SECRET"       # 步骤1获取

  bitable:
    app_token: "YOUR_BITABLE_APP_TOKEN"  # 步骤3获取
    tables:
      clients: "TABLE_ID_1"          # 客户信息表ID
      projects: "TABLE_ID_2"         # 项目执行表ID
      pressure_tests: "TABLE_ID_3"   # 压力测试表ID
      feedback: "TABLE_ID_4"         # 客户反馈表ID

  bot:
    webhook_url: "YOUR_WEBHOOK_URL"  # 步骤4获取（可选）
```

### 6. 测试连接

```bash
python scripts/platform_integration_manager.py
```

如果看到 `✅ 平台集成管理器已初始化 - 使用平台: FEISHU`，说明配置成功！

---

## 📝 方案B：使用Notion（5分钟配置）

### 1. 创建Notion Integration

1. 访问 [Notion Integrations](https://www.notion.so/my-integrations)
2. 点击 "+ New integration"
3. 填写名称："GEO Tool"
4. 复制 **Internal Integration Token**（以 `secret_` 开头）

### 2. 创建数据库

在Notion中创建4个数据库（Database）：

#### 数据库1：客户数据库
属性：
- 客户名称（Title）
- 行业类型（Select）：医美、护肤、器械、其他
- 项目状态（Select）：待启动、进行中、已完成、暂停
- 开始日期（Date）
- 描述（Text）

#### 数据库2：项目数据库
属性：
- 项目名称（Title）
- 客户（Relation → 客户数据库）
- 执行阶段（Select）：D、B、C、A
- 执行状态（Select）：待执行、执行中、已完成、失败
- 开始时间（Date）
- 完成时间（Date）
- 质量评分（Number）

#### 数据库3：测试数据库
属性：
- 测试名称（Title）
- 项目（Relation → 项目数据库）
- 测试时间（Date）
- 关键词数量（Number）
- 平均得分（Number）
- 提及率（Number）
- 趋势（Select）：↑、→、↓

#### 数据库4：反馈数据库
属性：
- 反馈标题（Title）
- 客户（Relation → 客户数据库）
- 反馈类型（Select）：满意、建议、投诉
- 处理状态（Select）：待处理、处理中、已解决
- 反馈内容（Text）

### 3. 分享数据库给Integration

1. 打开每个数据库
2. 点击右上角"..."→ "Connections" → 选择你的Integration（GEO Tool）
3. 复制数据库链接，提取Database ID
   - URL格式：`https://www.notion.so/YOUR_DATABASE_ID?v=...`

### 4. 填写配置文件

编辑 `config/platform_config.yaml`：

```yaml
default_platform: notion

notion:
  api_key: "secret_XXXXXXXXXXXX"  # 步骤1获取的Token

  databases:
    clients: "DATABASE_ID_1"        # 客户数据库ID
    projects: "DATABASE_ID_2"       # 项目数据库ID
    pressure_tests: "DATABASE_ID_3" # 测试数据库ID
    feedback: "DATABASE_ID_4"       # 反馈数据库ID

  pages:
    workspace_id: "YOUR_WORKSPACE_ID"  # 可选
```

### 5. 测试连接

```bash
python scripts/platform_integration_manager.py
```

---

## 🔄 方案C：双平台模式（推荐）

同时配置飞书和Notion，在Streamlit界面中切换：

```yaml
# 默认使用飞书
default_platform: feishu

feishu:
  # ... 飞书完整配置

notion:
  # ... Notion完整配置
```

在GEO工具的"设置"页面，可以随时切换平台。

---

## 🎯 使用流程

### 启动应用

```bash
streamlit run scripts/app.py
```

### 创建项目（自动同步）

1. 登录GEO工具
2. 进入"🚀 新建项目"
3. 填写客户信息
4. 点击"保存并立即开始运行"

**自动发生的事情：**
- ✅ 在飞书/Notion创建项目记录
- ✅ 执行GEO流水线（D→B→C→A）
- ✅ 实时更新阶段进度
- ✅ 生成交付文档
- ✅ 发送完成通知

### 查看项目

- **飞书**：打开多维表格 → 查看项目记录
- **Notion**：打开数据库 → 查看项目卡片

---

## 🛠️ 高级功能

### 1. 自定义通知

编辑 `feishu_adapter.py` 中的通知模板，定制消息格式。

### 2. 添加自定义字段

在飞书/Notion中添加新字段后，更新 `feishu_adapter.py` 或 `notion_adapter.py` 的字段映射。

### 3. 切换平台

在"设置"页面选择平台，点击"保存平台配置"。

---

## ❓ 常见问题

### Q1: 提示"获取access_token失败"
**A**: 检查飞书的App ID和Secret是否正确，是否开启了"通讯录"权限。

### Q2: Notion提示"403 Forbidden"
**A**: 确保数据库已分享给Integration，并且Token有效。

### Q3: 如何查看同步日志？
**A**: 日志会在终端输出，带有 `✅` 或 `❌` 标记。

### Q4: 可以只用本地存储，不用飞书/Notion吗？
**A**: 可以！注释掉 `app.py` 中的平台集成代码即可，工具仍会正常运行。

---

## 📚 下一步

- 📊 [添加数据可视化](./完善方案.md#模块2数据可视化增强)
- 🤖 [配置自动化工作流](./完善方案.md#模块4自动化工作流)
- 👥 [创建客户门户](./完善方案.md#模块5客户门户)

---

**需要帮助？**
联系技术支持或查看 [飞书开发文档](https://open.feishu.cn/document/) | [Notion API文档](https://developers.notion.com/)
